#pragma config(Sensor, S1,     HTBM,           sensorI2CCustom)
#pragma config(Sensor, S4,     NXT2WIFI,       sensorHighSpeed)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

/**
 * benedettelli-nxt2wifi.h provides an API for Daniele's NXT2WiFi Sensor. This program
 * demonstrates how to use that API.
 *
 * Changelog:
 * - 0.1: Initial release
 *
 * Credits:
 * - Big thanks to Daniele Benedettelli for providing me with the hardware necessary to write and test this.
 *
 * License: You may use this code as you wish, provided you give credit where it's due.
 *
 * THIS CODE WILL ONLY WORK WITH ROBOTC VERSION 4.10 AND HIGHER

 * Xander Soldaat (xander_at_botbench.com)
 * 22 November 2012
 * version 0.1
 */
#define __RS485_DEBUG__ 1

#include "common.h"
#include "timer.h"
#include "hitechnic-barometer.h"
#include "benedettelli-nxt2wifi.h"

long dataTemp = 0;
long dataPress = 0;
long txbytes = 0;
long rxbytes = 0;
string IPaddress = "0.0.0.0";
string connStatus = "disconnected";

// hack
// char *tweethost = "arduino-tweet.appspot.com";
char *line1 = "POST http://arduino-tweet.appspot.com/update HTTP/1.0\nContent-Length: ";
//char *line2 = "Content-Length: %d\n";
char *line3 = "token=30675988-XmplwBFpIfkBV3WwCW5wL63P1d3uOICOLrmkMNw";
char *line4 = "&status=Hello from NXT2WIFI in Rotterdam";
//char *line4 = "&status=%d";
//char *line5 = " people have pressed the button in the past 5 minutes. The current temp is ";
//char *line6 = "%2.1fC.";

// tHugeByteArray data;
tHugeByteArray payloadData;

task updateScreen()
{
  while(true)
  {
    displayTextLine(0, "Stat: %s", connStatus);
    displayTextLine(1, "%s",IPaddress);
    displayTextLine(2, "-------------------");
    displayTextLine(3, "Temp : %2.2f", (float)dataTemp/100.0);
    displayTextLine(4, "Press: %d", dataPress);
    displayTextLine(5, "Light:");
    displayTextLine(6, "Sound:");
    displayTextLine(7, "RX/TX: %d/%d", rxbytes, txbytes);
    sleep(100);
  }
}

// Constantly read the sensors
task pollSensors()
{
  while (true)
  {
    dataPress = HTBMreadMInHg(HTBM);
    sleep(100);
    dataTemp = HTBMreadTemp(HTBM) * 100;
    sleep(1000);
  }
}

bool tweet()
{
  char *data;
  //char *line1 = "POST http://arduino-tweet.appspot.com/update HTTP/1.0\nContent-Length: ";
  //char *line2 = "Content-Length: %d\n";
  //char *line3 = "token=30675988-XmplwBFpIfkBV3WwCW5wL63P1d3uOICOLrmkMNw";
  //char *line4 = "&status=Hello from NXT2WIFI in Prague";

  writeDebugStream(line1);
  memset(payloadData, 0, sizeof(tHugeByteArray));
  memcpy(payloadData, line1, strlen(line1));
  N2WTCPWrite(1, payloadData, strlen(line1));

  sprintf(data, "%d, %d\n", strlen(line3), strlen(line4));
  writeDebugStream(data);
  memset(payloadData, 0, sizeof(tHugeByteArray));
  memcpy(payloadData, data, strlen(data));
  N2WTCPWrite(1, payloadData, strlen(data));

  writeDebugStream(line3);
  memset(payloadData, 0, sizeof(tHugeByteArray));
  memcpy(payloadData, line3, strlen(line3));
  N2WTCPWrite(1, payloadData, strlen(line3));

  writeDebugStream(line4);
  memset(payloadData, 0, sizeof(tHugeByteArray));
  memcpy(payloadData, line4, strlen(line4));
  N2WTCPWrite(1, payloadData, strlen(line4));

  return true;
}

task main ()
{
  startTask(pollSensors);
  startTask(updateScreen);

  N2WsetDebug(true);
  sleep(100);
  //sleep(1000);
  //stopAllTasks();

  // initialise the port, etc
  RS485initLib();
  sleep(100);
  N2WsetDebug(true);
  sleep(100);

  // Disconnect if already connected
  N2WDisconnect();
  sleep(500);

  // if a custom profile exists, use that instead
  if (!N2WCustomExist())
  {
    stopTask(updateScreen);
    sleep(50);
    eraseDisplay();
    playSound(soundException);
    displayCenteredBigTextLine(1, "ERROR");
    displayTextLine(3, "No custom profile");
    displayTextLine(4, "configured!!");
    while(true) EndTimeSlice();
  }

  N2WLoad();

  sleep(100);
  N2WConnect(true);
  connStatus = "connecting";

  while (!N2WConnected())
    sleep(1000);

  connStatus = "connected";
  playSound(soundBeepBeep);

  sleep(15000);
  N2WgetIP(IPaddress);

  sleep(1000);
  N2WTCPClose(0);
  sleep(1000);
  if (!N2WTCPOpenClient(1, "arduino-tweet.appspot.com", 80))
    writeDebugStreamLine("Err open port");

  tweet();

  //if (!N2WUDPOpenServer(1, 161))
  //  writeDebugStreamLine("Err open port");
  //while (true)
  //{
  //  avail = N2WUDPAvail(1);
  //  if (avail > 0)
  //  {
  //    rxbytes += avail;
  //    N2WchillOut();
  //    N2WUDPRead(1, avail);
  //    if (SNMPdecode(reqID, oid))
  //    {
    //    writeDebugStreamLine("------------------");
    //    for (short i = 0; i < sizeof(oid); i++)
    //    {
    //      writeDebugStream("0x%02x ", oid[i] & 0xFF);
    //    }
    //    writeDebugStreamLine("");
    //    for (short i = 0; i < sizeof(oidTree); i++)
    //    {
    //      writeDebugStream("0x%02x ", oidTree[i] & 0xFF);
    //    }
    //    writeDebugStreamLine("\n------------------");
   //     if (memcmp(oid, oidName, 8) == 0)
   //     {
   //       getFriendlyName(dataString);
    //      totsize = genSNMPreply(reqID, communityName, oid, 8, dataString);
    //      N2WUDPWrite(1, data, totsize);
    //      txbytes += totsize;
    //    }
    //    else if (memcmp(oid, oidTree, 4) == 0)
    //    {
    //      dataString = "unknown";

    //      switch(oid[4])
    //      {
    //        case oidTemp:  sensorData = dataTemp; break;
    //        case oidPress: sensorData = dataPress; break;
    //        case oidSound: sensorData = dataSound; break;
    //        case oidLight: sensorData = dataLight; break;
    //      }
    //      totsize = genSNMPreply(reqID, communityName, oid, 5, sensorData);
    //      N2WUDPWrite(1, data, totsize);
    //      txbytes += totsize;
    //    }
    //    else
   //     {
   //       writeDebugStreamLine("unknown oid");
   //     }
   //   }
   //   else
   //   {
   //     writeDebugStreamLine("Invalid packet");
   //   }
   // }
  //  sleep(100);
  //}
}
